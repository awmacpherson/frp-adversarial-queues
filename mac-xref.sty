%
% BIBLIOGRAPHY AND CROSS-REFERENCING
%
% v2.0.0
%

\NeedsTeXFormat{LaTeX2e}
\ProvidesPackage{mac-xref}

\RequirePackage{mac-util}

\pgfkeys{biblatex/backend/.code={\PassOptionsToPackage{backend=#1}{biblatex}}}
\pgfkeys{biblatex/backend=biber}
%\pgfkeys{biblatex/style/.code={\PassOptionsToPackage{style=#1}{biblatex}}}
%\pgfkeys{biblatex/style=alphabetic}
\ProcessPGFOptions

%

\RequirePackage[style=alphabetic]{biblatex}
\setcounter{biburllcpenalty}{1}   % freely break URLs at lowercase

% use \addbibresource to register .bib databases

% Legacy syntax (LaTeX): place
%
% \bibliography{<bibpath>}
% \bibliographystyle{alpha}
%
% where you wish the bibliography to appear. Generates a list environment.

% About backends:
% bibtex reads both the .aux file and .bib file.
% biber reads ONLY the .bcf file which is generated by biblatex 
% when backend=biber.
%
% About biblatex:
% loads etoolbox
% Use \nopp to suppress p. pp. in postnote. 
% Alternatively, change pagination field in bib entry.
% For arXiv compatibility require versions:
%  .bbl format 2.8 biblatex 3.7 Biber 2.7
%  (as of May 2020, arXiv uses TeXLive 2016)


\providecommand \citepath [3] {\pgfkeys{#1/.code={\cite[#3]{#2}}}}

\let\rootdir\relax % to be overwritten by user
\DeclareFieldFormat{path}{\href{\rootdir/#1}{\texttt{#1}}}
\DeclareFieldFormat{v}{(v.#1)}

\DeclareBibliographyDriver{lsentry}%
  {\hfill \printfield{title} \printfield[v]{version}}

\defbibheading{lsheading} {\paragraph{#1}}
\defbibenvironment{ls}
  {\list{\printfield[path]{url}}
    {
    \setlength{\leftmargin}{0pt}
    \setlength{\itemindent}{\labelwidth+\biblabelsep}
    \setlength{\itemsep}{\bibitemsep}
    \setlength{\parsep}{\bibparsep}
    } 
  }
  {\endlist}
  {\item}

\RequirePackage{csquotes} % prevents a warning for using biblatex with babel


%
%%% CROSS REFERENCING %%%%%%%%%%%%%%%%%%%%%%
%

% These packages must be loaded after amsmath because the latter redefines
% the \label command for equation numbering.

% TO DO: consider using zref
% OR a key-value system like pgfkeys or L3 keys for hierarchical labels

%\RequirePackage{xr-hyper}    % LOAD BEFORE HYPERREF

% Provides \externaldocument[cite_prefix]{path}.

% This is the tool to make documents interdependent.
% It is used by stacksproject.

\RequirePackage[colorlinks=true,
                linkcolor=teal,
                citecolor=olive,
                destlabel=true,
                bookmarks=true]{hyperref}

% Turns cross-references into links by redefining \refstepcounter
% Turns citations into links by redefining \bibcite
% Turns amsmath equation numbers into links by unknown wizardry
% Provides \href{}{}

\RequirePackage{bookmark}

% Patches hyperref so that it only needs one run and no auxiliary file 
% (otherwise .out is generated). Cf. https://ctan.org/pkg/bookmark

% TO DO: use colorlinks=true with xcolor (or with package default hycolor)
% Which commands does this redefine?


\RequirePackage[inline]{showlabels}
\renewcommand \showlabelfont {\scriptsize\ttfamily\color{lightgray}}
\renewcommand \showlabelrefline {\hrule width 0em height 2ex depth 0pt }
% patches \label and possibly \cite command
